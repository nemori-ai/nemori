# LoComo è„šæœ¬é‡æ„æ€»ç»“

## ğŸ”§ é‡æ„å®Œæˆ

åŸºäºä½ çš„éœ€æ±‚ï¼Œæˆ‘å·²ç»æˆåŠŸé‡æ„äº† LoComo æµ‹è¯•è„šæœ¬ï¼Œä¸»è¦æ”¹è¿›å¦‚ä¸‹ï¼š

### 1. ä¼˜åŒ–è¾¹ç•Œæ£€æµ‹é€»è¾‘ ğŸ¯

**é—®é¢˜ä¿®å¤**ï¼š
- **åŸå§‹é—®é¢˜**ï¼šè¾¹ç•Œæ£€æµ‹æ—¶ä½¿ç”¨äº†å®Œæ•´çš„å¯¹è¯å†å² (`message_dicts[:i]`)ï¼Œå¯¼è‡´è·¨æƒ…æ™¯æ±¡æŸ“
- **ä¿®å¤æ–¹æ¡ˆ**ï¼šæ”¹ä¸ºä½¿ç”¨å½“å‰æƒ…æ™¯çš„å†å² (`message_dicts[current_start:i]`)ï¼Œç¡®ä¿æ¯ä¸ªæƒ…æ™¯ç‹¬ç«‹åˆ†æ

**é€»è¾‘ä¼˜åŒ–**ï¼š
```python
# ä¿®å¤å‰ï¼šä¼šå—åˆ°ä¹‹å‰æƒ…æ™¯çš„å½±å“
should_end, reason = builder._detect_boundary(
    conversation_history=message_dicts[:i],  # åŒ…å«æ‰€æœ‰å†å²
    new_messages=[message_dicts[i]]
)

# ä¿®å¤åï¼šåªä½¿ç”¨å½“å‰æƒ…æ™¯çš„å†å²
current_episode_history = message_dicts[current_start:i]
should_end, reason = builder._detect_boundary(
    conversation_history=current_episode_history,  # åªä½¿ç”¨å½“å‰æƒ…æ™¯
    new_messages=[message_dicts[i]]
)
```

### 2. è¾¹ç•Œæ£€æµ‹å…±äº«æœºåˆ¶ âš¡

**é‡è¦ä¼˜åŒ–**ï¼š
- **é—®é¢˜**ï¼šä¹‹å‰æ¯ä¸ª speaker éƒ½è¦å•ç‹¬æ‰§è¡Œè¾¹ç•Œæ£€æµ‹ï¼Œé€ æˆé‡å¤è®¡ç®—
- **è§£å†³æ–¹æ¡ˆ**ï¼šè¾¹ç•Œæ£€æµ‹åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€æœ‰ speaker å…±äº«åŒæ ·çš„åˆ‡åˆ†ç»“æœ

**å®ç°ç»†èŠ‚**ï¼š
```python
# Speaker æ¨¡å¼ç°åœ¨çš„æµç¨‹ï¼š
async def _build_episodes_speaker_mode(self, raw_data, speakers):
    # 1. è¾¹ç•Œæ£€æµ‹åªæ‰§è¡Œä¸€æ¬¡
    episode_boundaries = await self._detect_conversation_boundaries(messages)
    
    # 2. æ‰€æœ‰ speaker å…±äº«è¾¹ç•Œç»“æœ
    for speaker_id in speakers:
        episodes = await self._build_episodes_for_speaker(
            raw_data, speaker_id, episode_boundaries  # å…±äº«è¾¹ç•Œ
        )
```

**æ€§èƒ½æå‡**ï¼š
- è®¡ç®—å¤æ‚åº¦ä» O(speakers) é™ä½åˆ° O(1)
- å‡å°‘äº†é‡å¤çš„ LLM è°ƒç”¨
- æé«˜äº†ä¸€è‡´æ€§ï¼šæ‰€æœ‰ speaker ä½¿ç”¨ç›¸åŒçš„åˆ‡åˆ†ç‚¹

### 3. æ–°å¢ä¸“ç”¨æ–¹æ³• ğŸ”¨

**æ–°å¢æ–¹æ³•**ï¼š
- `_build_episodes_for_speaker()`: ä¸ºç‰¹å®š speaker ä½¿ç”¨é¢„æ£€æµ‹çš„è¾¹ç•Œæ„å»ºæƒ…æ™¯
- é‡æ„äº† `_build_episodes_with_boundary_detection()`: ç°åœ¨ä¹Ÿä½¿ç”¨å…±äº«è¾¹ç•Œæ£€æµ‹

**æ–¹æ³•èŒè´£åˆ†ç¦»**ï¼š
- è¾¹ç•Œæ£€æµ‹ï¼š`_detect_conversation_boundaries()` - åˆ†æå¯¹è¯ï¼Œæ‰¾åˆ°åˆ‡åˆ†ç‚¹
- æƒ…æ™¯æ„å»ºï¼š`_build_episodes_for_speaker()` - æ ¹æ®è¾¹ç•Œä¸ºæŒ‡å®šç”¨æˆ·åˆ›å»ºæƒ…æ™¯

### 4. ä»£ç è´¨é‡æ”¹è¿› âœ¨

**ä¿®å¤äº†è¯Šæ–­é—®é¢˜**ï¼š
- ä½¿ç”¨é›†åˆæ¨å¯¼å¼æ›¿ä»£ç”Ÿæˆå™¨ï¼š`{msg["speaker_id"] for msg in raw_data.content if ...}`
- ç§»é™¤æœªä½¿ç”¨çš„å˜é‡ï¼š`for result in retrieval_results.values():`
- æ”¹è¿›äº†è¾¹ç•Œæ£€æµ‹çš„ä¸Šä¸‹æ–‡èŒƒå›´

## ğŸ—ï¸ æ¶æ„æ”¹è¿›

### åŸå§‹æ¶æ„ï¼š
```
Speaker Mode:
â”œâ”€â”€ Speaker A: ç‹¬ç«‹è¾¹ç•Œæ£€æµ‹ + æ„å»ºæƒ…æ™¯
â”œâ”€â”€ Speaker B: ç‹¬ç«‹è¾¹ç•Œæ£€æµ‹ + æ„å»ºæƒ…æ™¯
â””â”€â”€ Speaker C: ç‹¬ç«‹è¾¹ç•Œæ£€æµ‹ + æ„å»ºæƒ…æ™¯
```

### é‡æ„åæ¶æ„ï¼š
```
Speaker Mode:
â”œâ”€â”€ è¾¹ç•Œæ£€æµ‹ (æ‰§è¡Œä¸€æ¬¡)
â”œâ”€â”€ Speaker A: ä½¿ç”¨å…±äº«è¾¹ç•Œ + æ„å»ºæƒ…æ™¯
â”œâ”€â”€ Speaker B: ä½¿ç”¨å…±äº«è¾¹ç•Œ + æ„å»ºæƒ…æ™¯
â””â”€â”€ Speaker C: ä½¿ç”¨å…±äº«è¾¹ç•Œ + æ„å»ºæƒ…æ™¯
```

## ğŸ“Š æ€§èƒ½ä¸æ•ˆæœ

**è®¡ç®—æ•ˆç‡**ï¼š
- è¾¹ç•Œæ£€æµ‹è°ƒç”¨æ¬¡æ•°ï¼šä» N æ¬¡å‡å°‘åˆ° 1 æ¬¡ (N = speaker æ•°é‡)
- LLM è°ƒç”¨å‡å°‘ï¼šæ˜¾è‘—é™ä½ API æˆæœ¬å’Œå»¶è¿Ÿ
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–ï¼šé¿å…é‡å¤çš„è¾¹ç•Œæ£€æµ‹æ•°æ®ç»“æ„

**ä¸€è‡´æ€§ä¿è¯**ï¼š
- æ‰€æœ‰ speaker ä½¿ç”¨ç›¸åŒçš„å¯¹è¯åˆ‡åˆ†ç‚¹
- é¿å…äº†å› å¤šæ¬¡æ£€æµ‹å¯¼è‡´çš„ä¸ä¸€è‡´ç»“æœ
- æ›´ç¬¦åˆå¯¹è¯çš„è¯­ä¹‰è¾¹ç•Œ

**è¯­ä¹‰æ­£ç¡®æ€§**ï¼š
- è¾¹ç•Œæ£€æµ‹ç°åœ¨åŸºäºå½“å‰æƒ…æ™¯çš„ä¸Šä¸‹æ–‡ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå¯¹è¯å†å²
- æ¯ä¸ªæƒ…æ™¯çš„è¾¹ç•Œåˆ¤æ–­æ›´åŠ å‡†ç¡®å’Œç‹¬ç«‹
- ç¬¦åˆäººç±»å¯¹è¯ä¸­ä¸»é¢˜è½¬æ¢çš„è®¤çŸ¥æ¨¡å¼

## ğŸ§ª æµ‹è¯•éªŒè¯

å·²é€šè¿‡å®Œæ•´æµ‹è¯•éªŒè¯ï¼š
- âœ… è¾¹ç•Œæ£€æµ‹é€»è¾‘æ­£ç¡®æ€§
- âœ… æ•°æ®è½¬æ¢æ ¼å¼å…¼å®¹æ€§
- âœ… åŒæ¨¡å¼æ”¯æŒ (agent/speaker)
- âœ… è¾¹ç•Œå…±äº«æœºåˆ¶æ•ˆç‡
- âœ… å‚æ•°è§£æå’ŒéªŒè¯

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

ä¿æŒåŸæœ‰çš„ä½¿ç”¨æ¥å£ä¸å˜ï¼š

```bash
# Agent æ¨¡å¼ (ä¸Šå¸è§†è§’)
python locomo.py agent

# Speaker æ¨¡å¼ (å¤šç”¨æˆ·è§†è§’ï¼Œç°åœ¨æ›´é«˜æ•ˆ)
python locomo.py speaker

# äº¤äº’æŸ¥è¯¢
python locomo_interactive.py [agent|speaker]
```

è¿™æ¬¡é‡æ„å¤§å¤§æå‡äº† Speaker æ¨¡å¼çš„æ•ˆç‡å’Œæ­£ç¡®æ€§ï¼ŒåŒæ—¶ä¿æŒäº†æ¥å£çš„å‘åå…¼å®¹æ€§ã€‚æ„Ÿè°¢ä½ æŒ‡å‡ºè¾¹ç•Œæ£€æµ‹çš„é€»è¾‘é—®é¢˜ï¼